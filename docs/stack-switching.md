# 新曙光：项目历史背景和新技术栈选型

> Functional Reactive Programming Rocks!

> 返回 [系列目录](../readme.md)

## 背景

公司的一个的 Web 软件项目（产品定位是可视化“H5”作品编辑器），有几十个功能和系统，几十万行源码，并且开发周期非常长（以年计），早期的技术栈为 Backbone + jQuery。

虽说是 Backbone 也算是老牌 MVC 了，但是实际上项目中并没有利用好这套机制。有部分非常早期的功能甚至并没有用 Backbone，而是通过手写回调和硬编码完成数据-视图的更新。另一部分用了 Backbone 的业务功能，也有部分代码的实现是反模式的，依然是硬编码的调用逻辑，没有遵循 Backbone 自带的 MVC 模式和响应式机制。

总的来说，项目的日常开发和维护比较痛苦。这些是技术层面遇到的问题，有了问题就要想办法解决。

### 思考一：

基于现有的 Backbone + jQuery 技术栈继续优化代码，把不良实现改成符合 Backbone MVC 风格的标准实现。

但是仔细一想，这么做是没前途的，jQuery 作为上世代技术，它优点在于封装和简化了 DOM 操作，并提高了兼容性。但是在本世代框架（React 等）前，谁还手写 DOM 操作？谁还研究 jQuery 性能调优（Virtual DOM 它不香吗）？

而 Backbone 之所以不再流行，自然也有相比 VAR 三家新框架的不足。（比如写法繁琐，组件嵌套处理麻烦）

既然要进行代码优化，有空继续扑腾淘汰科技，还不如索性考虑一下是不是可以对技术栈进行全面升级。

### 思考二：

升级技术栈说来简单，但是实施起来就困难了，那可是几十万行的历史代码呢。

干脆全部推倒重构？

丢掉历史包袱是很爽，但是包袱不是说丢就能丢的，技术债务可以丢掉，业务总不能丢掉吧？所以是要先投入几百个人月的资源重新实现所有业务吗？那可太不 agile 了，我们也没有这么多资源。

### 思考三：

既然全部重构是不现实的，那么是否可以小规模地重构，基于现有代码进行局部功能的技术转型，然后逐渐推广到所有功能上呢。这样成本和步调是渐进的，是可以接受的。

### ~~思考四：~~

~~这我顶不住，我跑路了拜拜~~

## 技术栈最终选型

![4 to 6 weeks later](./img/4-to-6-weeks-later-fs8.png)

既然开工了就尽量一步到位。我花了一个多月，完全脱产进行学习和调研，从零了解了几十个工具。（也是我个人技术力解放的一个里程碑）

所调研的工具，包括但不限于 React、Vue 渲染层框架（没错，在这之前我只接触过项目内的 Backbone 和 jQuery，没有了解过这些本世代框架），Redux、Vuex、Mobx、unstated-next 等不同的状态管理工具，TypeScript、RxJS、Ramda 等周边工具。

我们的产品比较重，考虑到成本、先进性、可扩展性、稳定性之间的平衡。我最终确定了新技术栈的基本选型：

|                | 旧技术栈                                            | 新技术栈            |
| -------------- | --------------------------------------------------- | ------------------- |
| **Model**      |                                                     |                     |
| 全局 State     | Backbone.Model，直接挂载 window 手动管理            | Redux               |
| 组件内状态     | Backbone.Model，局部变量手动管理                    | React Hooks         |
| 数据类型       | （丢失）                                            | TypeScript          |
| **View**       |                                                     |                     |
| 模板化         | Underscore.template                                 | JSX                 |
| **ViewModel**  |                                                     |                     |
| 组件化         | Backbone.View                                       | React.FC            |
| Event Handling | Backbone.View.events, jQuery.on                     | （直接写在 JSX 中） |
| Model Binding  | Backbone.Model.on, callback                         | react-redux         |
| View Binding   | Backbone.View.render, jQuery 手动编写 DOM 逻辑      | （React 自动完成）  |
| **事件**       |                                                     |                     |
| 事件工具       | Backbone.on, eventEmitter3, 自己写的 util, callback | RxJS                |
| **编码**       |                                                     |                     |
| 语法           | 只能写 ES5，不支持 ES6+ （缺少 Babel 编译）         | TypeScript          |
| 模块化         | require.js，或直接挂载到 window                     | import              |
| 范式           | OOP                                                 | FP, FRP             |
| **工具库**     |                                                     |                     |
| 数据处理       | Underscore, Lodash                                  | ES6 API, Ramda      |
| 网络           | jQuery.ajax                                         | Axios               |

主要是：

- 以 React 为主的新技术栈，并初步实现了渐进式升级的方案和代码原型。（这套方案现在已在项目中落地）
- 整合了一些以前用不同工具实现相同作用的情况，提供了唯一指定方案。（比如事件层用 RxJS 代替 Events 和我们自己编写的一些 util）
- 还规划了要达到最终目标，所要经过的阶段性 Roadmap：`旧技术栈` -> `新旧技术栈共存，逐渐改造剔除旧代码` -> `新技术栈`。

Wow，先进生产力谁不爱呢，这看起来振奋人心！

不过，回到我们的根本目标，干掉旧技术栈是为了让代码写起来更爽、更可维护。实际上，要真的利用好新技术新工具，让它们在产品中长期地发挥价值，更需要理解这些工具背后的编程思想。

于是，在试图解决历史问题的同时，其实引入了额外的问题：提高了对开发人员的要求。尤其是需要前端技术负责人时时进行 Review 和把控代码质量，即时重构和优化具体代码。

| 新技术栈              | 编程思想                               |
| --------------------- | -------------------------------------- |
| Redux                 | 函数式编程、数据驱动编程、发布订阅模式 |
| React.FC、React Hooks | 函数式编程                             |
| Ramda                 | 函数式编程                             |
| RxJS                  | 响应式编程、Stream 编程、发布订阅模式  |
| TypeScript            | 静态类型                               |
| Axios                 | Promise、Await                         |

话又说回来，本来我们产品的定位也决定了，我们的开发人员对这些编程思想的储备是必要条件。恰恰是因为以前没有重视它们，才使得现有的代码存在诸多问题。

React 也好、jQuery 也好，本质上都只是工具。而对工具的使用，只是开发人员思考的延伸和具象。

## 下一步

那么，在确定了技术栈，并进行了小规模代码原型验证之后，接着要着手对项目进行改造了。

下一个问题是，如何进入到 Roadmap 中的第二阶段：漫长的新旧技术栈共存时期。
